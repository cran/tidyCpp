<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Dirk Eddelbuettel" />
  <title>tidyCpp Motivation</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <style type="text/css">
body {
max-width: 50rem;
margin-left: auto;
margin-right: auto;
font-family: system-ui;
}

code {
padding: 2px;
border-radius: unset;
}

pre {
background-color: unset;
border: solid #aaa 1px;
padding: 8px;
}
pre.numberSource {
margin: 0;
padding-left: 0;
}
div.sourceCode {
overflow: visible;
}
pre, pre.sourceCode {
overflow-x: auto;
}
pre>code {
white-space: pre;
overflow: visible;
background-color: unset;
padding: 0;
}
pre.sourceCode.numberSource {
overflow-x: visible;
}
pre.sourceCode.numberSource>code {
white-space: pre-wrap
}
pre.sourceCode.numberSource>code>span {
left: 8px;
text-indent: -4.6em;
}

.chunk-summary {
text-align: right;
}
.chunk-summary+pre,
.chunk-summary+div.sourceCode {
margin-top: 2px;
}

nav > ul {
border: .0625rem solid #444;
border-radius: 4px;
margin: 5px;
padding: 5px;
}
nav ul {
list-style-type: none;
padding-inline-start: 1rem;
}
nav ul li {
padding: 0;
}
nav ul ul {
margin-top: 0;
margin-bottom: 0;
padding-top: 0;
padding-bottom: 0;
}
nav code {
background-color: unset;
color: unset;
}
</style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">tidyCpp Motivation</h1>
<p class="author">Dirk Eddelbuettel</p>
<p class="date">Initial version November 2020; Updated August 2021</p>
</header>
<!--
%\VignetteIndexEntry{tidyCpp Motivation}
%\VignetteEngine{simplermarkdown::mdweave_to_html}
%\VignetteEncoding{UTF-8}
-->
<h2 id="introducing-tidycpp">Introducing tidyCpp</h2>
<p>The <code>tidyCpp</code> package offers a simple, small and clean C++
layer over the C API offered by R. As of version 0.0.4, it also adds a
(truly minimal) numeric vector class for C++. This vignette highlights a
few usage examples, often taken from the <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html"><em>Writing
R Extensions</em> vignette that comes with R</a>, to highlight some
features.</p>
<p><code>tidyCpp</code> has no further dependencies on any other
package. It can however be used with <a href="https://www.rcpp.org">Rcpp</a> simply to take advantage of its
helper functions <code>cppFunction()</code> or
<code>sourceCpp()</code>.</p>
<p><code>tidyCpp</code> is still a fairly small package. Please free to
contribute by make suggestions, or sending bugfixes or extension
proposals.</p>
<h3 id="snippet-one-dimnames">Snippet One: dimnames</h3>
<p>This example comes from <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Attributes">Writing
R Extension, Section 5.9.4</a> which highlights attribute setting from
the C API.</p>
<p>It takes two (named) numeric vectors, computes the outer product
matrix and uses the names to set row- and column names. Note that we
modified the existing example ever so slight by ensuring (as is
frequently done) remapping of symbols. For example, <code>length</code>
(which can clash easily with existing symbols in the global namespace)
is now <code>Rf_length</code>. We also added an <code>export</code> tag
for <code>Rcpp</code> simply to facilitate integration into R. No Rcpp
header or data structures are used; we simply rely on its logic in
getting C or C++ source into R.</p>
<div class="columns">
<div class="column" style="width:49.75%;">
<h4 id="using-the-c-api-for-r">Using the C API for R</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define R_NO_REMAP</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>SEXP out<span class="op">(</span>SEXP x<span class="op">,</span> SEXP y<span class="op">)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> nx <span class="op">=</span> Rf_length<span class="op">(</span>x<span class="op">),</span> ny <span class="op">=</span> Rf_length<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  SEXP ans <span class="op">=</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    PROTECT<span class="op">(</span>Rf_allocMatrix<span class="op">(</span>REALSXP<span class="op">,</span> nx<span class="op">,</span> ny<span class="op">));</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>rx <span class="op">=</span> REAL<span class="op">(</span>x<span class="op">),</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>ry <span class="op">=</span> REAL<span class="op">(</span>y<span class="op">),</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>rans <span class="op">=</span> REAL<span class="op">(</span>ans<span class="op">);</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nx<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> tmp <span class="op">=</span> rx<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> ny<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>      rans<span class="op">[</span>i <span class="op">+</span> nx<span class="op">*</span>j<span class="op">]</span> <span class="op">=</span> tmp <span class="op">*</span> ry<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  SEXP dimnames <span class="op">=</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    PROTECT<span class="op">(</span>Rf_allocVector<span class="op">(</span>VECSXP<span class="op">,</span> <span class="dv">2</span><span class="op">));</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  SET_VECTOR_ELT<span class="op">(</span>dimnames<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>                 Rf_getAttrib<span class="op">(</span>x<span class="op">,</span>R_NamesSymbol<span class="op">));</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  SET_VECTOR_ELT<span class="op">(</span>dimnames<span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>                 Rf_getAttrib<span class="op">(</span>y<span class="op">,</span>R_NamesSymbol<span class="op">));</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  Rf_setAttrib<span class="op">(</span>ans<span class="op">,</span> R_DimNamesSymbol<span class="op">,</span> dimnames<span class="op">);</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  UNPROTECT<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div><div class="column" style="width:0.5%;">
<p> </p>
</div><div class="column" style="width:49.75%;">
<h4 id="using-tidycpp">Using tidyCpp</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;tidyCpp&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(tidyCpp)]]</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>SEXP out<span class="op">(</span>SEXP x<span class="op">,</span> SEXP y<span class="op">)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> nx <span class="op">=</span> R<span class="op">::</span>length<span class="op">(</span>x<span class="op">),</span> ny <span class="op">=</span> R<span class="op">::</span>length<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>Protect ans<span class="op">(</span>R<span class="op">::</span>allocMatrixReal<span class="op">(</span>nx<span class="op">,</span> ny<span class="op">));</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>rx <span class="op">=</span> R<span class="op">::</span>numericPointer<span class="op">(</span>x<span class="op">),</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>ry <span class="op">=</span> R<span class="op">::</span>numericPointer<span class="op">(</span>y<span class="op">),</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>rans <span class="op">=</span> R<span class="op">::</span>numericPointer<span class="op">(</span>ans<span class="op">);</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nx<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> tmp <span class="op">=</span> rx<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> ny<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      rans<span class="op">[</span>i <span class="op">+</span> nx<span class="op">*</span>j<span class="op">]</span> <span class="op">=</span> tmp <span class="op">*</span> ry<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>Protect dimnames<span class="op">(</span>R<span class="op">::</span>allocVectorList<span class="op">(</span><span class="dv">2</span><span class="op">));</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>setVectorElement<span class="op">(</span>dimnames<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                      R<span class="op">::</span>getNames<span class="op">(</span>x<span class="op">));</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>setVectorElement<span class="op">(</span>dimnames<span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                      R<span class="op">::</span>getNames<span class="op">(</span>y<span class="op">));</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>setDimNames<span class="op">(</span>ans<span class="op">,</span> dimnames<span class="op">);</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ans<span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
</div>
<p>Some key differences:</p>
<ul>
<li>a single header <code>tidyCpp</code>: simple and clean;</li>
<li>no <code>PROTECT</code> and <code>UNPROTECT</code> with manual
calling of the number of calls made: C++ takes care of that for us via
<code>Protect</code> which is a modernized (and simplified) version of
class <code>Shield</code> in Rcpp (and see below for more discussion of
<code>Protect</code>);</li>
<li>no <code>Rf_*</code> calls: everything used comes from a clean new
namespace <code>R</code> and is easily identified;</li>
<li>types are made explicit in the name of the called function sequence
rather than enum;</li>
<li>consistent naming that aligns with language convention:
<ul>
<li><em>types</em> such as <code>Protect</code> are capitalized,
and</li>
<li><em>verbs</em> such as the allocators or converters are
camelCase;</li>
</ul></li>
<li>overall less wordy and shorter, <em>e.g.</em>,
<code>R::getNames(x)</code> instead of
<code>Rf_getAttrib(x, R_NamesSymbol)</code>;</li>
<li>no macros are being used.</li>
</ul>
<p>Note that the use of <code>Rcpp::export</code> does not imply use of
Rcpp data structures. We simply take advantaged of the tried and true
code generation to make it easy to call the example from R. You can copy
either example into a temporary file and use
<code>Rcpp::sourceCpp(&quot;filenameHere&quot;)</code> on it to run the
example.</p>
<h3 id="snippet-two-convolution">Snippet Two: convolution</h3>
<p>This example comes from <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Calling-_002eCall">Writing
R Extension, Section 5.10.1</a> which introduces the
<code>.Call()</code> interface of the C API for R.</p>
<p>It takes two numeric vectors and computes a convolution. Note that as
above we modified the existing example ever so slight by ensuring (as is
frequently done) remapping of symbols, once again added an
<code>export</code> tag for <code>Rcpp</code> simply to facilitate
integration into R, and changing whitespace. No Rcpp header or data
structures are used; we simply rely on its logic in getting C or C++
source into R.</p>
<div class="columns">
<div class="column" style="width:49.75%;">
<h4 id="using-the-c-api-for-r-1">Using the C API for R</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define R_NO_REMAP</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>SEXP convolve2<span class="op">(</span>SEXP a<span class="op">,</span> SEXP b<span class="op">)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> na<span class="op">,</span> nb<span class="op">,</span> nab<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>xa<span class="op">,</span> <span class="op">*</span>xb<span class="op">,</span> <span class="op">*</span>xab<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  SEXP ab<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  a <span class="op">=</span> PROTECT<span class="op">(</span>Rf_coerceVector<span class="op">(</span>a<span class="op">,</span> REALSXP<span class="op">));</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  b <span class="op">=</span> PROTECT<span class="op">(</span>Rf_coerceVector<span class="op">(</span>b<span class="op">,</span> REALSXP<span class="op">));</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  na <span class="op">=</span> Rf_length<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  nb <span class="op">=</span> Rf_length<span class="op">(</span>b<span class="op">);</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  nab <span class="op">=</span> na <span class="op">+</span> nb <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  ab <span class="op">=</span> PROTECT<span class="op">(</span>Rf_allocVector<span class="op">(</span>REALSXP<span class="op">,</span> nab<span class="op">));</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  xa <span class="op">=</span> REAL<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  xb <span class="op">=</span> REAL<span class="op">(</span>b<span class="op">);</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  xab <span class="op">=</span> REAL<span class="op">(</span>ab<span class="op">);</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nab<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    xab<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> na<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nb<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>      xab<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">+=</span> xa<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> xb<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  UNPROTECT<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ab<span class="op">;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div><div class="column" style="width:0.5%;">
<p> </p>
</div><div class="column" style="width:49.75%;">
<h4 id="using-tidycpp-1">Using tidyCpp</h4>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;tidyCpp&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(tidyCpp)]]</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>SEXP convolve2<span class="op">(</span>SEXP a<span class="op">,</span> SEXP b<span class="op">)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> na<span class="op">,</span> nb<span class="op">,</span> nab<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="op">*</span>xa<span class="op">,</span> <span class="op">*</span>xb<span class="op">,</span> <span class="op">*</span>xab<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>Protect pa<span class="op">(</span>R<span class="op">::</span>coerceVectorNumeric<span class="op">(</span>a<span class="op">));</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>Protect pb<span class="op">(</span>R<span class="op">::</span>coerceVectorNumeric<span class="op">(</span>b<span class="op">));</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  na <span class="op">=</span> R<span class="op">::</span>length<span class="op">(</span>pa<span class="op">);</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  nb <span class="op">=</span> R<span class="op">::</span>length<span class="op">(</span>pb<span class="op">);</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  nab <span class="op">=</span> na <span class="op">+</span> nb <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>Protect ab<span class="op">(</span>R<span class="op">::</span>allocVectorNumeric<span class="op">(</span>nab<span class="op">));</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  xa <span class="op">=</span> R<span class="op">::</span>numericPointer<span class="op">(</span>pa<span class="op">);</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  xb <span class="op">=</span> R<span class="op">::</span>numericPointer<span class="op">(</span>pb<span class="op">);</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  xab <span class="op">=</span> R<span class="op">::</span>numericPointer<span class="op">(</span>ab<span class="op">);</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nab<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    xab<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> na<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nb<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>      xab<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">+=</span> xa<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> xb<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ab<span class="op">;</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
</div>
<p>Like the previous example, the new version operates without macros,
does not require manual counting in <code>PROTECT</code> and
<code>UNPROTECT</code> and is, to our eyes, a little more readable.</p>
<p>As the existing example from <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Calling-_002eCall">Writing
R Extension, Section 5.10.1</a> used <code>PROTECT</code> on the two
incoming <code>SEXP</code> objects (whereas the previous example, from
the same source, does not) we need to allocate two tempary objects
<code>pa</code> and <code>pb</code> with the explicit C++ ownership
providing the protect and unprotect pairing. Because <code>pa</code> and
<code>pb</code> go out of scope at the end of the function, the
destructor will then unprotect correctly.</p>
<p>(And as above, the two ‘tags’ for Rcpp use are present only to
facilitate use via the <code>Rcpp::sourceCpp()</code> package.)</p>
<h3 id="snippet-three-uchardet">Snippet Three: uchardet</h3>
<p>For the third example, we use an unrelated package: <a href="https://cran.r-project.org/package=uchardet">uchardet</a> which
provides R bindings to the eponymous C++ library to detect character
encodings. This example cannot be sourced simply into R as it requires
the underlying C++ library. One can, however, download the R package and
then replace the file <code>src/detect.cpp</code> with the content
below, and add <code>LinkingTo: tidyCpp</code> to the
<code>DESCRIPTION</code> file.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;tidyCpp&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Visibility.h&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fstream&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;uchardet.h&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BUFFER_SIZE </span><span class="dv">65536</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> buffer<span class="op">[</span>BUFFER_SIZE<span class="op">];</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>SEXP attribute_hidden get_charset<span class="op">(</span><span class="dt">uchardet_t</span> handle<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">char</span><span class="op">*</span> ans <span class="op">=</span> uchardet_get_charset<span class="op">(</span>handle<span class="op">);</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>strlen<span class="op">(</span>ans<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Rf_warning(&quot;Can not detect encoding.&quot;);</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NA_STRING<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> R<span class="op">::</span>mkChar<span class="op">(</span>ans<span class="op">);</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>SEXP attribute_hidden do_detect_sexp<span class="op">(</span>SEXP x<span class="op">,</span> <span class="dt">uchardet_t</span> handle<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">R_xlen_t</span> x_len <span class="op">=</span> R<span class="op">::</span>xlength<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>x_len <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NA_STRING<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">char</span><span class="op">*</span> x_data<span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span><span class="op">(</span>R<span class="op">::</span>Typeof<span class="op">(</span>x<span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> CHARSXP<span class="op">:</span> <span class="op">{</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> NA_STRING<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> NA_STRING<span class="op">;</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      x_data <span class="op">=</span> R<span class="op">::</span>charPointer<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> RAWSXP<span class="op">:</span> <span class="op">{</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>      x_data <span class="op">=</span> <span class="op">(</span><span class="at">const</span> <span class="dt">char</span><span class="op">*)</span> R<span class="op">::</span>rawPointer<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      R<span class="op">::</span>warning<span class="op">(</span><span class="st">&quot;Unsupported data type &#39;</span><span class="sc">%s</span><span class="st">&#39;.&quot;</span><span class="op">,</span> R<span class="op">::</span>type2char<span class="op">(</span>R<span class="op">::</span>Typeof<span class="op">(</span>x<span class="op">)));</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> NA_STRING<span class="op">;</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> retval <span class="op">=</span> uchardet_handle_data<span class="op">(</span>handle<span class="op">,</span> x_data<span class="op">,</span> x_len<span class="op">);</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  uchardet_data_end<span class="op">(</span>handle<span class="op">);</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>retval <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Rf_warning(&quot;Can not handling data.&quot;);</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NA_STRING<span class="op">;</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> get_charset<span class="op">(</span>handle<span class="op">);</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>SEXP attribute_hidden do_detect_file<span class="op">(</span>SEXP x<span class="op">,</span> <span class="dt">uchardet_t</span> handle<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> NA_STRING<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NA_STRING<span class="op">;</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">char</span><span class="op">*</span> fname <span class="op">=</span> R<span class="op">::</span>charPointer<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>ifstream<span class="op"> </span>fs<span class="op">(</span>R_ExpandFileName<span class="op">(</span>fname<span class="op">),</span> <span class="bu">std::</span>ios<span class="bu">::</span>binary<span class="op">);</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>fs<span class="op">.</span>is_open<span class="op">())</span> <span class="op">{</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    R<span class="op">::</span>warning<span class="op">(</span><span class="st">&quot;Can not open file &#39;</span><span class="sc">%s</span><span class="st">&#39;.&quot;</span><span class="op">,</span> fname<span class="op">);</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> NA_STRING<span class="op">;</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>fs<span class="op">.</span>eof<span class="op">())</span> <span class="op">{</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    fs<span class="op">.</span>read<span class="op">(</span>buffer<span class="op">,</span> BUFFER_SIZE<span class="op">);</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t<span class="op"> </span>len <span class="op">=</span> fs<span class="op">.</span>gcount<span class="op">();</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    uchardet_handle_data<span class="op">(</span>handle<span class="op">,</span> buffer<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  uchardet_data_end<span class="op">(</span>handle<span class="op">);</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  fs<span class="op">.</span>close<span class="op">();</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> get_charset<span class="op">(</span>handle<span class="op">);</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>SEXP attribute_hidden do_detect_vec<span class="op">(</span>SEXP x<span class="op">,</span> T fun<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>R<span class="op">::</span>Typeof<span class="op">(</span>x<span class="op">)</span> <span class="op">!=</span> STRSXP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    R<span class="op">::</span>error<span class="op">(</span><span class="st">&quot;&#39;x&#39; must be character vector.&quot;</span><span class="op">);</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>  <span class="dt">R_xlen_t</span> n <span class="op">=</span> R<span class="op">::</span>xlength<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>Protect res<span class="op">(</span>R<span class="op">::</span>allocVectorCharacter<span class="op">(</span>n<span class="op">));</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uchardet_t</span> handle <span class="op">=</span> uchardet_new<span class="op">();</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">R_len_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    R<span class="op">::</span>setStringElement<span class="op">(</span>res<span class="op">,</span> i<span class="op">,</span> fun<span class="op">(</span>R<span class="op">::</span>stringElement<span class="op">(</span>x<span class="op">,</span> i<span class="op">),</span> handle<span class="op">));</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>    uchardet_reset<span class="op">(</span>handle<span class="op">);</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  uchardet_delete<span class="op">(</span>handle<span class="op">);</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>SEXP detect_character<span class="op">(</span>SEXP x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> do_detect_vec<span class="op">(</span>x<span class="op">,</span> do_detect_sexp<span class="op">);</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>SEXP detect_file<span class="op">(</span>SEXP x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> do_detect_vec<span class="op">(</span>x<span class="op">,</span> do_detect_file<span class="op">);</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>SEXP detect_raw<span class="op">(</span>SEXP x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>R<span class="op">::</span>Typeof<span class="op">(</span>x<span class="op">)</span> <span class="op">!=</span> RAWSXP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    R<span class="op">::</span>error<span class="op">(</span><span class="st">&quot;&#39;x&#39; must be raw vector.&quot;</span><span class="op">);</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>Protect res<span class="op">(</span>R<span class="op">::</span>allocVectorCharacter<span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uchardet_t</span> handle <span class="op">=</span> uchardet_new<span class="op">();</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>  R<span class="op">::</span>setStringElement<span class="op">(</span>res<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> do_detect_sexp<span class="op">(</span>x<span class="op">,</span> handle<span class="op">));</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>  uchardet_delete<span class="op">(</span>handle<span class="op">);</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="snippet-four-rolling-min-and-max">Snippet Four: Rolling min and
max</h3>
<p>For the fourth example, we modified a function from an older version
of package <a href="https://cran.r-project.org/package=uchardet">ichimoku</a>. It
implements a rolling minimum and maximum operator (in an earlier version
of the package, see <em>e.g.</em> <a href="https://github.com/shikokuchuo/ichimoku/blob/6462c5ee65642f8018bd51ae529499c705a15c95/src/windowfns.cpp">for
the file</a>. Its use of Rcpp is fairly standard, however the package
chose to make changes based on the compilation time so we took a look
too. The version below deploys <code>tidyCpp</code> and its new
<code>numvec</code> header and class instead (and we tested this in a
local fork of the package).</p>
<p>To make the code fit in the dual display below, we added linebreaks
on the left, and adjusted whitespace. Our code on the right also
slightly changes the interface by simplyfing the implementation: without
the <code>enum</code> and <code>struct Args</code> and dual callers, we
add a third argument to determine whether we operate as min or max which
saves the two extra functions at the bottom. We also altered whitespace
away from our preferred use of four spaces; see the original function
(also containing full copyright headers and more) <a href="https://github.com/eddelbuettel/dang/blob/master/src/rollMinMax.cpp">here</a>.</p>
<p>The key point, however, is immediately apparent. The two version are
essentially identical (though the Rcpp version will have more type
checks, exception handling, wrapper generation and all the other reasons
why often use Rcpp).</p>
<div class="columns">
<div class="column" style="width:49.75%;">
<h4 id="using-the-rcpp-version">Using the Rcpp version</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;deque&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;utility&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">// types of calculations</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> CalcType <span class="op">{</span>MIN<span class="op">,</span> MAX<span class="op">};</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">// function arguments for non-data</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Args <span class="op">{</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> window<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  CalcType ctype<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">// calculates rolling window for {min, max}</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>NumericVector</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>roll_minmax<span class="op">(</span><span class="at">const</span> NumericVector<span class="op">&amp;</span> x<span class="op">,</span> Args a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n  <span class="op">=</span> x<span class="op">.</span>length<span class="op">();</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  NumericVector rollx<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>deque<span class="op">&lt;</span><span class="bu">std::</span>pair<span class="op">&lt;</span><span class="dt">long</span> <span class="dt">double</span><span class="op">,</span> <span class="dt">int</span><span class="op">&gt;&gt;</span> deck<span class="op">;</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> x<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>a<span class="op">.</span>ctype <span class="op">==</span> MIN<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="op">(!</span>deck<span class="op">.</span>empty<span class="op">()</span> <span class="op">&amp;&amp;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>             deck<span class="op">.</span>back<span class="op">().</span>first <span class="op">&gt;=</span> x<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        deck<span class="op">.</span>pop_back<span class="op">();</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="op">(!</span>deck<span class="op">.</span>empty<span class="op">()</span> <span class="op">&amp;&amp;</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>             deck<span class="op">.</span>back<span class="op">().</span>first <span class="op">&lt;=</span> x<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        deck<span class="op">.</span>pop_back<span class="op">();</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    deck<span class="op">.</span>push_back<span class="op">(</span><span class="bu">std::</span>make_pair<span class="op">(</span>x<span class="op">[</span>i<span class="op">],</span> i<span class="op">));</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span>deck<span class="op">.</span>front<span class="op">().</span>second <span class="op">&lt;=</span> i <span class="op">-</span> a<span class="op">.</span>window<span class="op">)</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>      deck<span class="op">.</span>pop_front<span class="op">();</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="dt">double</span> min <span class="op">=</span> deck<span class="op">.</span>front<span class="op">().</span>first<span class="op">;</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> a<span class="op">.</span>window <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>      rollx<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> NA_REAL<span class="op">;</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>      rollx<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> min<span class="op">;</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> rollx<span class="op">;</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>NumericVector maxOver<span class="op">(</span><span class="at">const</span> SEXP<span class="op">&amp;</span> x<span class="op">,</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">int</span> window<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>  Args a<span class="op">;</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span>window <span class="op">=</span> window<span class="op">;</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span>ctype <span class="op">=</span> MAX<span class="op">;</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> roll_minmax<span class="op">(</span>x<span class="op">,</span> a<span class="op">);</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>NumericVector minOver<span class="op">(</span><span class="at">const</span> SEXP<span class="op">&amp;</span> x<span class="op">,</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">int</span> window<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  Args a<span class="op">;</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span>window <span class="op">=</span> window<span class="op">;</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span>ctype <span class="op">=</span> MIN<span class="op">;</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> roll_minmax<span class="op">(</span>x<span class="op">,</span> a<span class="op">);</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div><div class="column" style="width:0.5%;">
<p> </p>
</div><div class="column" style="width:49.75%;">
<h4 id="using-tidycpp-2">Using tidyCpp</h4>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;deque&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;utility&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;tidyCpp&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">// forward declaration</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>tidy<span class="op">::</span>NumVec rollMinMax<span class="op">(</span>tidy<span class="op">::</span>NumVec x<span class="op">,</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">int</span> window<span class="op">,</span> <span class="dt">bool</span> isMin<span class="op">);</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">// this SEXP variant is referenced from init.c</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>SEXP _rollMinMax<span class="op">(</span>SEXP x<span class="op">,</span> SEXP win<span class="op">,</span> SEXP isMin<span class="op">){</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> rollMinMax<span class="op">(</span>x<span class="op">,</span> R<span class="op">::</span>asInteger<span class="op">(</span>win<span class="op">),</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                    R<span class="op">::</span>asLogical<span class="op">(</span>isMin<span class="op">)));</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculates rolling window for {min, max}</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>tidy<span class="op">::</span>NumVec</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>rollMinMax<span class="op">(</span>tidy<span class="op">::</span>NumVec x<span class="op">,</span> <span class="dt">int</span> win<span class="op">,</span> <span class="dt">bool</span> isMin<span class="op">){</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n  <span class="op">=</span> R<span class="op">::</span>length<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  tidy<span class="op">::</span>NumVec rollx<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>deque<span class="op">&lt;</span><span class="bu">std::</span>pair<span class="op">&lt;</span><span class="dt">long</span> <span class="dt">double</span><span class="op">,</span> <span class="dt">int</span><span class="op">&gt;&gt;</span> deck<span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>isMin<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="op">(!</span>deck<span class="op">.</span>empty<span class="op">()</span> <span class="op">&amp;&amp;</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>             deck<span class="op">.</span>back<span class="op">().</span>first <span class="op">&gt;=</span> x<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        deck<span class="op">.</span>pop_back<span class="op">();</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="op">(!</span>deck<span class="op">.</span>empty<span class="op">()</span> <span class="op">&amp;&amp;</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>             deck<span class="op">.</span>back<span class="op">().</span>first <span class="op">&lt;=</span> x<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        deck<span class="op">.</span>pop_back<span class="op">();</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    deck<span class="op">.</span>push_back<span class="op">(</span><span class="bu">std::</span>make_pair<span class="op">(</span>x<span class="op">[</span>i<span class="op">],</span> i<span class="op">));</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span>deck<span class="op">.</span>front<span class="op">().</span>second <span class="op">&lt;=</span> i <span class="op">-</span> win<span class="op">)</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>      deck<span class="op">.</span>pop_front<span class="op">();</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="dt">double</span> min <span class="op">=</span> deck<span class="op">.</span>front<span class="op">().</span>first<span class="op">;</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> win <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>      rollx<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> NA_REAL<span class="op">;</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>      rollx<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> min<span class="op">;</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> rollx<span class="op">;</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// extern &quot;C&quot;</span></span></code></pre></div>
</div>
</div>
<h3 id="protect-and-unprotect">PROTECT and UNPROTECT</h3>
<p>The <code>R::Protect()</code> class ensures proper
<code>PROTECT</code> wrapping for the lifetime of an object. A very
important, yet easy-to-overlook, detail is that the form of assigning to
a <code>SEXP</code> variable <em>looks</em> correct, but is in fact
incorrect. For example in
<code>SEXP ans = R::Protect(R::allocMatrixReal(nx, ny));</code>, the
class will correctly construct around the result from
<code>allocMatrix()</code>. But as it assigned to a <code>SEXP</code>
variable, the compiler realizes that it is a temporary object and after
calling <code>operator SEXP()</code> the destructor is
called—essentially immediately.</p>
<p>So the correct use is to write
<code>R::Protect ans(R::allocMatrixReal(nx, ny));</code> which turns
this into an instance of the the <code>Protect</code> which will live to
the end of the scope and only <code>UNRPROTECT</code> via the destructor
at the end of the scope.</p>
<p>The example file <code>snippets/protectExamples.cpp</code>
illustrates this by using <a href="https://cran.r-project.org/package=RcppSpdlog">RcppSpdlog</a> to
log invocation of the three relevant parts constructor, destructor and
<code>operator SEXP()</code> for both the correct and incorrect form of
the ’convolution()<code>example. When</code>sourceCpp()`-ed into an R
session, and skipping the first example in the file, we may see the
following result (with of course different timestamps).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>R<span class="sc">&gt;</span> <span class="fu">convolveIncorrect</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418260</span>] starting convolveIncorrect</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418286</span>] entered ctor</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418288</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418290</span>] entered dtor</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418291</span>] entered ctor</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418293</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418295</span>] entered dtor</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418297</span>] entered ctor</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418298</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418300</span>] entered dtor</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418302</span>] ending convolveIncorrect</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>]  <span class="dv">4</span> <span class="dv">13</span> <span class="dv">28</span> <span class="dv">27</span> <span class="dv">18</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>R<span class="sc">&gt;</span> <span class="fu">convolveCorrect</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>))</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418431</span>] starting convolveCorrect</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418434</span>] entered ctor</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418435</span>] entered ctor</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418436</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418438</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418439</span>] entered ctor</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418441</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418442</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418444</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418445</span>] ending convolveCorrect</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418447</span>] entered <span class="fu">SEXP</span>()</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418449</span>] entered dtor</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418450</span>] entered dtor</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span><span class="sc">:</span><span class="dv">25</span><span class="sc">:</span><span class="fl">56.418452</span>] entered dtor</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>]  <span class="dv">4</span> <span class="dv">13</span> <span class="dv">28</span> <span class="dv">27</span> <span class="dv">18</span></span></code></pre></div>
<p>In the first example, we see that the triplet
constructor/SEXP()/destructor is called twice when the two vectors are
coerced, and then a third time when the result vector is allocated. This
shows the incorrect behavior: destructors essentially immediately after
constructors, leaving the object unprotected—which is not what was
intended.</p>
<p>The second example shows the correct behavior. Two constructor calls,
then two <code>SEXP()</code> calls (when the length are determined),
another constructor followed by three <code>SEXP()</code> calls from the
three <code>numericPointer()</code> calls—as well as a final
<code>SEXP()</code> call for the return result and three destructors at
end. This is the intended behavior of protecting the three objects
during their lifetime.</p>
<h3 id="discussion">Discussion</h3>
<p><code>tidyCpp</code> provides a cleaner layer on top of the C API for
R (as well as a so-far still minimal C++ class layer). That has its
advantages: we find it more readable. It conceivably has possible
disadvantages. Those familiar with the C API for R may not need this,
and may find it an unnecessary new dialect. Time will tell if new
adoption and use may outway possible hesitation by other. In the
meantime, the package “does no harm”, has no further dependencies and
can be used, or dropped, at will</p>
<h3 id="summary">Summary</h3>
<p>The <code>tidyCpp</code> package provides a simplifying layer on top
of the time-tested but somewhat crusty C API for R.</p>
</body>
</html>
